# 実装方式の選定ガイド

Skill 実装は「まずこの方式」と固定せず、毎回比較して選定する。

## 比較対象

1. 公式CLI
2. 公式SDK
3. 直接HTTP（`curl` / `fetch` / `requests` など）

## 判定基準

- **カバー率**: 必要な操作を過不足なく実行できるか
- **認証難易度**: OAuth / token 管理を安全に扱えるか
- **運用性**: エラー分類、再試行、デバッグが容易か
- **保守性**: 依存更新・仕様追従がしやすいか
- **実装速度**: 初期実装と検証を短時間で回せるか

## 実装前プリフライト（必須）

外部APIを使う skill は、実装開始前に次を必ず実施する。

1. 公式一次情報（API docs / 公式README / 公式SDK docs）を確認
2. 実URL・実認証で最小成功ケースを `curl` / 公式CLI / SDKサンプルで実行
3. 成否条件を記録
   - 成功時: 最低限のレスポンス形
   - 失敗時: HTTPコード、エラーメッセージ、再現条件
   - 実行に必要なヘッダ要件（例: `Authorization`, `User-Agent`）

このプリフライトが通っていない状態で本実装に進まない。

## ユーザー操作抽象化（必須）

- ユーザーに直接 CLI / スクリプト実行を要求しない。
- 必要な CLI 操作はエージェントが実行し、ユーザーには意図確認と選択入力のみ求める。
- 「ユーザーが `scripts/*.sh` を実行する」前提はアンチパターンとして扱う。
- 状態変更操作は、実行前に必ず確認ターンを挟み、確認前に実行しない。

## 公式CLIを採用する条件

次を満たすときは公式CLIを第一候補にする。

- 必要機能を十分カバーしている
- 出力が機械処理しやすい（JSON等）
- SDK/HTTP直叩きより安全で実装が単純

## 公式CLI採用時の必須手順（nix-home）

直接グローバルインストールは行わない。必ず Nix で導入する。

1. attr 探索: `ok-search` を使う
2. 導入: `ok-install` を使う
3. 検証: `make build` / `make switch` / `command -v <cli>`
4. Skill に記録: 使用CLI、必須オプション、失敗時リカバリ

## SDKを採用する条件

- 公式CLIにない機能が必要
- 型安全や高水準APIが有利
- ページング/バッチ処理/複雑なモデル変換が必要

## 直接HTTPを採用する条件

- 公式CLI/SDKが未整備
- 利用範囲が狭く、HTTP呼び出しの方が実装が短い
- 認証・リトライ・レート制御を明示的に管理したい

## 生成物への反映

- `SKILL.md` に選定理由と代替案却下理由を簡潔に残す
- `references/source-manifest.json` に根拠URL/commit/取得日を記録する
- プリフライト結果（成功条件/失敗条件）を `SKILL.md` か `references/` に残す
